<!DOCTYPE html>
<html lang="zh-Hans">
    <!-- title -->




<!-- keywords -->




<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="author" content="ddddfang">
    <meta name="renderer" content="webkit">
    <meta name="copyright" content="ddddfang">
    
    <meta name="keywords" content="hexo,hexo-theme,hexo-blog">
    
    <meta name="description" content="nothing to be told">
    <meta http-equiv="Cache-control" content="no-cache">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>hash-table · ddddfang&#39;s Blog</title>
    <style type="text/css">
    @font-face {
        font-family: 'Oswald-Regular';
        src: url("/font/Oswald-Regular.ttf");
    }

    body {
        margin: 0;
    }

    header,
    footer,
    .back-top,
    .sidebar,
    .container,
    .site-intro-meta,
    .toc-wrapper {
        display: none;
    }

    .site-intro {
        position: relative;
        z-index: 3;
        width: 100%;
        /* height: 50vh; */
        overflow: hidden;
    }

    .site-intro-placeholder {
        position: absolute;
        z-index: -2;
        top: 0;
        left: 0;
        width: calc(100% + 300px);
        height: 100%;
        background: repeating-linear-gradient(-45deg, #444 0, #444 80px, #333 80px, #333 160px);
        background-position: center center;
        transform: translate3d(-226px, 0, 0);
        animation: gradient-move 2.5s ease-out 0s infinite;
    }

    @keyframes gradient-move {
        0% {
            transform: translate3d(-226px, 0, 0);
        }
        100% {
            transform: translate3d(0, 0, 0);
        }
    }

</style>

    <link rel="preload" href="/css/style.css?v=20180824" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <link rel="stylesheet" href="/css/mobile.css?v=20180824" media="(max-width: 980px)">
    
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    
    <!-- /*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
/* This file is meant as a standalone workflow for
- testing support for link[rel=preload]
- enabling async CSS loading in browsers that do not support rel=preload
- applying rel preload css once loaded, whether supported or not.
*/ -->
<script>
(function( w ){
	"use strict";
	// rel=preload support test
	if( !w.loadCSS ){
		w.loadCSS = function(){};
	}
	// define on the loadCSS obj
	var rp = loadCSS.relpreload = {};
	// rel=preload feature support test
	// runs once and returns a function for compat purposes
	rp.support = (function(){
		var ret;
		try {
			ret = w.document.createElement( "link" ).relList.supports( "preload" );
		} catch (e) {
			ret = false;
		}
		return function(){
			return ret;
		};
	})();

	// if preload isn't supported, get an asynchronous load by using a non-matching media attribute
	// then change that media back to its intended value on load
	rp.bindMediaToggle = function( link ){
		// remember existing media attr for ultimate state, or default to 'all'
		var finalMedia = link.media || "all";

		function enableStylesheet(){
			link.media = finalMedia;
		}

		// bind load handlers to enable media
		if( link.addEventListener ){
			link.addEventListener( "load", enableStylesheet );
		} else if( link.attachEvent ){
			link.attachEvent( "onload", enableStylesheet );
		}

		// Set rel and non-applicable media type to start an async request
		// note: timeout allows this to happen async to let rendering continue in IE
		setTimeout(function(){
			link.rel = "stylesheet";
			link.media = "only x";
		});
		// also enable media after 3 seconds,
		// which will catch very old browsers (android 2.x, old firefox) that don't support onload on link
		setTimeout( enableStylesheet, 3000 );
	};

	// loop through link elements in DOM
	rp.poly = function(){
		// double check this to prevent external calls from running
		if( rp.support() ){
			return;
		}
		var links = w.document.getElementsByTagName( "link" );
		for( var i = 0; i < links.length; i++ ){
			var link = links[ i ];
			// qualify links to those with rel=preload and as=style attrs
			if( link.rel === "preload" && link.getAttribute( "as" ) === "style" && !link.getAttribute( "data-loadcss" ) ){
				// prevent rerunning on link
				link.setAttribute( "data-loadcss", true );
				// bind listeners to toggle media back
				rp.bindMediaToggle( link );
			}
		}
	};

	// if unsupported, run the polyfill
	if( !rp.support() ){
		// run once at least
		rp.poly();

		// rerun poly on an interval until onload
		var run = w.setInterval( rp.poly, 500 );
		if( w.addEventListener ){
			w.addEventListener( "load", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		} else if( w.attachEvent ){
			w.attachEvent( "onload", function(){
				rp.poly();
				w.clearInterval( run );
			} );
		}
	}


	// commonjs
	if( typeof exports !== "undefined" ){
		exports.loadCSS = loadCSS;
	}
	else {
		w.loadCSS = loadCSS;
	}
}( typeof global !== "undefined" ? global : this ) );
</script>

    <link rel="icon" href="/assets/img/target.ico">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js" as="script">
    <link rel="preload" href="/scripts/main.js" as="script">
    <link rel="preload" as="font" href="/font/Oswald-Regular.ttf" crossorigin="">
    <link rel="preload" as="font" href="https://at.alicdn.com/t/font_327081_1dta1rlogw17zaor.woff" crossorigin="">
    
    <!-- fancybox -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" defer></script>
    <!-- 百度统计  -->
    
    <!-- 谷歌统计  -->
    
</head>

    
        <body class="post-body">
    
    
<header class="header">

    <div class="read-progress"></div>
    <div class="header-sidebar-menu">&#xe775;</div>
    <!-- post页的toggle banner  -->
    
    <div class="banner">
            <div class="blog-title">
                <a href="/">ddddfang&#39;s Blog.</a>
            </div>
            <div class="post-title">
                <a href="#" class="post-name">hash-table</a>
            </div>
    </div>
    
    <a class="home-link" href="/">ddddfang's Blog.</a>
</header>
    <div class="wrapper">
        <div class="site-intro" style="







height:50vh;
">
    
    <!-- 主页  -->
    
    
    <!-- 404页  -->
            
    <div class="site-intro-placeholder"></div>
    <div class="site-intro-img" style="background-image: url(/intro/post-bg.jpg)"></div>
    <div class="site-intro-meta">
        <!-- 标题  -->
        <h1 class="intro-title">
            <!-- 主页  -->
            
            hash-table
            <!-- 404 -->
            
        </h1>
        <!-- 副标题 -->
        <p class="intro-subtitle">
            <!-- 主页副标题  -->
            
            
            <!-- 404 -->
            
        </p>
        <!-- 文章页meta -->
        
            <div class="post-intros">
                <!-- 文章页标签  -->
                
                    <div class="post-intro-tags">
    
        <a class="post-tag" href="javascript:void(0);" data-tags="hash-table">hash-table</a>
    
</div>
                
                
                    <div class="post-intro-read">
                        <span>字数统计: <span class="post-count word-count">7.2k</span>阅读时长: <span class="post-count reading-time">40 min</span></span>
                    </div>
                
                <div class="post-intro-meta">
                    <span class="post-intro-calander iconfont-archer">&#xe676;</span>
                    <span class="post-intro-time">2019/02/11</span>
                    
                    <span id="busuanzi_container_page_pv" class="busuanzi-pv">
                        <span class="iconfont-archer">&#xe602;</span>
                        <span id="busuanzi_value_page_pv"></span>
                    </span>
                    
                    <span class="shareWrapper">
                        <span class="iconfont-archer shareIcon">&#xe71d;</span>
                        <span class="shareText">Share</span>
                        <ul class="shareList">
                            <li class="iconfont-archer share-qr" data-type="qr">&#xe75b;
                                <div class="share-qrcode"></div>
                            </li>
                            <li class="iconfont-archer" data-type="weibo">&#xe619;</li>
                            <li class="iconfont-archer" data-type="qzone">&#xe62e;</li>
                            <li class="iconfont-archer" data-type="twitter">&#xe634;</li>
                            <li class="iconfont-archer" data-type="facebook">&#xe67a;</li>
                        </ul>
                    </span>
                </div>
            </div>
        
    </div>
</div>
        <script>
 
  // get user agent
  var browser = {
    versions: function () {
      var u = window.navigator.userAgent;
      return {
        userAgent: u,
        trident: u.indexOf('Trident') > -1, //IE内核
        presto: u.indexOf('Presto') > -1, //opera内核
        webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
        gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
        mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
        ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
        android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
        iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者安卓QQ浏览器
        iPad: u.indexOf('iPad') > -1, //是否为iPad
        webApp: u.indexOf('Safari') == -1, //是否为web应用程序，没有头部与底部
        weixin: u.indexOf('MicroMessenger') == -1, //是否为微信浏览器
        uc: u.indexOf('UCBrowser') > -1 //是否为android下的UC浏览器
      };
    }()
  }
  console.log("userAgent:" + browser.versions.userAgent);

  // callback
  function fontLoaded() {
    console.log('font loaded');
    if (document.getElementsByClassName('site-intro-meta')) {
      document.getElementsByClassName('intro-title')[0].classList.add('intro-fade-in');
      document.getElementsByClassName('intro-subtitle')[0].classList.add('intro-fade-in');
      var postIntros = document.getElementsByClassName('post-intros')[0]
      if (postIntros) {
        postIntros.classList.add('post-fade-in');
      }
    }
  }

  // UC不支持跨域，所以直接显示
  function asyncCb(){
    if (browser.versions.uc) {
      console.log("UCBrowser");
      fontLoaded();
    } else {
      WebFont.load({
        custom: {
          families: ['Oswald-Regular']
        },
        loading: function () {  //所有字体开始加载
          // console.log('loading');
        },
        active: function () {  //所有字体已渲染
          fontLoaded();
        },
        inactive: function () { //字体预加载失败，无效字体或浏览器不支持加载
          console.log('inactive: timeout');
          fontLoaded();
        },
        timeout: 5000 // Set the timeout to two seconds
      });
    }
  }

  function asyncErr(){
    console.warn('script load from CDN failed, will load local script')
  }

  // load webfont-loader async, and add callback function
  function async(u, cb, err) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (cb) { o.addEventListener('load', function (e) { cb(null, e); }, false); }
    if (err) { o.addEventListener('error', function (e) { err(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }

  var asyncLoadWithFallBack = function(arr, success, reject) {
      var currReject = function(){
        reject()
        arr.shift()
        if(arr.length)
          async(arr[0], success, currReject)
        }

      async(arr[0], success, currReject)
  }

  asyncLoadWithFallBack([
    "https://cdn.jsdelivr.net/npm/webfontloader@1.6.28/webfontloader.min.js", 
    "https://cdn.bootcss.com/webfont/1.6.28/webfontloader.js",
    "/lib/webfontloader.min.js"
  ], asyncCb, asyncErr)
</script>        
        <img class="loading" src="/assets/loading.svg" style="display: block; margin: 6rem auto 0 auto; width: 6rem; height: 6rem;" />
        <div class="container container-unloaded">
            <main class="main post-page">
    <article class="article-entry">
        <h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><p>A hash table consists of an array of ‘buckets’（吊桶）, each of which stores a key-value pair. In order to locate the bucket where a key-value pair should be stored, the key is passed through a hashing function. This function returns an integer which is used as the pair’s index in the array of buckets. When we want to retrieve a key-value pair, we supply the key to the same hashing function, receive its index, and use the index to find it in the array. Array indexing has algorithmic complexity O(1), making hash tables fast at storing and retrieving data.<br>The hash function we choose should:</p>
<ul>
<li>Take a string as its input and return a number between 0 and m, our desired bucket array length.</li>
<li>Return an even distribution of （平均分配）bucket indexes for an average set of inputs. If our hash function is unevenly distributed, it will put more items in some buckets than others. This will lead to a higher rate of collisions（冲突，碰撞） . Collisions reduce the efficiency of our hash table.</li>
</ul>
<p>Hash functions map an infinitely（无限的） large number of inputs to a finite number of outputs</p>
<p><em>来自 <a href="https://github.com/jamesroutley/write-a-hash-table/tree/master/01-introduction" target="_blank" rel="noopener">https://github.com/jamesroutley/write-a-hash-table/tree/master/01-introduction</a></em></p>
<p>hash表的内部过程是将一个string类型的key映射得到一个（数组的）index，这个index内容放什么是自定义的（value）。</p>
<h2 id="2-hash表实现的map和红黑树-or-skiplist-实现的map"><a href="#2-hash表实现的map和红黑树-or-skiplist-实现的map" class="headerlink" title="2. hash表实现的map和红黑树(or skiplist)实现的map"></a>2. hash表实现的map和红黑树(or skiplist)实现的map</h2><ul>
<li>hash表实现map查找插入删除几乎常数时间,效率极高,但占用内存一般高于实际存储的节点个数(不然冲突问题可能影响到效率),内部无序(因此无法范围查找)</li>
<li>红黑树实现map查找插入删除O(lgN)时间,和hash没法比.但占用内存少(=节点个数),内部有序(可按key排序),灵活(找不到exact key时甚至可以找一个最接近的)</li>
<li>skiplist实现map效率上和红黑树相同,但查找插入删除实现都比红黑树简单,且空间占用在1/4等比递减的时候比红黑树有优势</li>
</ul>
<p>一般而言,有序集合都是按key排序,若按插入顺序排序就简单了,再维护一个list即可</p>
<h2 id="3-一个存在问题的hash-table实现"><a href="#3-一个存在问题的hash-table实现" class="headerlink" title="3. 一个存在问题的hash table实现"></a>3. 一个存在问题的hash table实现</h2><p>hashtable.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __HASH_TABLE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HASH_TABLE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HT_PRIME_1 151</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HT_PRIME_2 153</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HT_INITIAL_BASE_SIZE 100</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span>* key;</span><br><span class="line">    <span class="keyword">void</span>* value;</span><br><span class="line">&#125; ht_item;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> base_size;</span><br><span class="line">    <span class="keyword">int</span> size;        <span class="comment">//size 和 count决定要不要resize hash表的大小,hash表太满不仅导致</span></span><br><span class="line">    <span class="keyword">int</span> count;        <span class="comment">//无法插入数据,还会使插入效率大大降低!因此动态调整hash表大小是必要的</span></span><br><span class="line">    ht_item** items;</span><br><span class="line">&#125; ht_hash_table;</span><br><span class="line"></span><br><span class="line"><span class="function">ht_hash_table *<span class="title">ht_new</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ht_del_hash_table</span><span class="params">(ht_hash_table* ht)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">ht_insert</span><span class="params">(ht_hash_table *ht, <span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">void</span> *value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">ht_search</span><span class="params">(ht_hash_table* ht, <span class="keyword">const</span> <span class="keyword">char</span>* key)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ht_delete</span><span class="params">(ht_hash_table* ht, <span class="keyword">const</span> <span class="keyword">char</span>* key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//void ht_show(ht_hash_table *ht);</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ht_map</span><span class="params">(ht_hash_table *ht,<span class="keyword">void</span> apply(<span class="keyword">const</span> <span class="keyword">char</span> *key,<span class="keyword">void</span> **value,<span class="keyword">void</span> *cl),<span class="keyword">void</span> *cl)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>hashtable.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hashTable.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//这是要判断x是不是质数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">is_prime</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">4</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ((x % <span class="number">2</span>) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">3</span>; i &lt;= <span class="built_in">floor</span>(<span class="built_in">sqrt</span>((<span class="keyword">double</span>) x)); i += <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((x % i) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//寻找一个 &gt;=x 的质数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">next_prime</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (is_prime(x) != <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        x++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> ht_item HT_DELETED_ITEM = &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;;        <span class="comment">//所有被delete的item都指向这货啊</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> ht_item *<span class="title">ht_new_item</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *k, <span class="keyword">void</span> *v)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ht_item *i = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(ht_item));</span><br><span class="line">    <span class="keyword">if</span>(i)</span><br><span class="line">    &#123;</span><br><span class="line">        i-&gt;key = strdup(k);                <span class="comment">//strdup = malloc and memcpy</span></span><br><span class="line">        i-&gt;value = v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ht_del_item</span><span class="params">(ht_item *i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(i-&gt;key)</span><br><span class="line">            <span class="built_in">free</span>(i-&gt;key);</span><br><span class="line">        <span class="built_in">free</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//哈希函数,a为给定的一个随机值吧</span></span><br><span class="line"><span class="comment">//s is key, a is a number(给的是个 prime), m is hash table size</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ht_hash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">const</span> <span class="keyword">int</span> a, <span class="keyword">const</span> <span class="keyword">int</span> m)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> hash = <span class="number">0</span>;        <span class="comment">//index</span></span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> len_s = <span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len_s; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//if strlen = 3, then s[0]*a^2 + s[1]*a^1 +s[2]*1; s[i] is ASCII value</span></span><br><span class="line">        hash += (<span class="keyword">long</span>)<span class="built_in">pow</span>(a, len_s - (i+<span class="number">1</span>)) * s[i];</span><br><span class="line">        <span class="comment">//refuce to hash tabel size scope</span></span><br><span class="line">        hash = hash % m;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>)hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果hash遇到冲突,将double hash, attempt 代表发生冲突的次数(初次为0其实就是hash_a)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ht_get_hash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">const</span> <span class="keyword">int</span> num_buckets, <span class="keyword">const</span> <span class="keyword">int</span> attempt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> hash_a = ht_hash(s, HT_PRIME_1, num_buckets);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> hash_b = ht_hash(s, HT_PRIME_2, num_buckets);</span><br><span class="line">    <span class="keyword">return</span> (hash_a + (attempt * (hash_b + <span class="number">1</span>))) % num_buckets; <span class="comment">//加1是为了防止hash得到0且冲突的case</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//新分配一个hash table,大小为 &gt;=base_size 的一个质数</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> ht_hash_table *<span class="title">ht_new_sized</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> base_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//ht_hash_table* ht = xmalloc(sizeof(ht_hash_table));        //xmalloc与malloc几乎一样,多了写log的功能</span></span><br><span class="line">    ht_hash_table *ht = (ht_hash_table *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(ht_hash_table));        <span class="comment">//xmalloc与malloc几乎一样,多了写log的功能</span></span><br><span class="line">    <span class="keyword">if</span>(!ht)</span><br><span class="line">        <span class="keyword">goto</span> FAIL;</span><br><span class="line">    ht-&gt;base_size = base_size;</span><br><span class="line"></span><br><span class="line">    ht-&gt;size = next_prime(ht-&gt;base_size);</span><br><span class="line"></span><br><span class="line">    ht-&gt;count = <span class="number">0</span>;</span><br><span class="line">    ht-&gt;items = <span class="built_in">calloc</span>((<span class="keyword">size_t</span>)ht-&gt;size, <span class="keyword">sizeof</span>(ht_item*));</span><br><span class="line">    <span class="keyword">if</span>(!ht-&gt;items)</span><br><span class="line">        <span class="keyword">goto</span> FAIL;</span><br><span class="line">    <span class="keyword">return</span> ht;</span><br><span class="line"></span><br><span class="line">FAIL:</span><br><span class="line">    <span class="keyword">if</span>(ht)</span><br><span class="line">        <span class="built_in">free</span>(ht);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//现在要resize,以新的 base_size</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ht_resize</span><span class="params">(ht_hash_table *ht, <span class="keyword">const</span> <span class="keyword">int</span> base_size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">if</span> (base_size &lt; HT_INITIAL_BASE_SIZE)        <span class="comment">//hash 表维护了一个最小的size</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    ht_hash_table *new_ht = ht_new_sized(base_size);</span><br><span class="line">    <span class="keyword">if</span>(!new_ht)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//将 hash table 原有内容挨个拷贝(插入)到新 table 的 桶 里面</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ht-&gt;size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ht_item* item = ht-&gt;items[i];</span><br><span class="line">        <span class="keyword">if</span> (item != <span class="literal">NULL</span> &amp;&amp; item != &amp;HT_DELETED_ITEM)</span><br><span class="line">        &#123;</span><br><span class="line">            ht_insert(new_ht, item-&gt;key, item-&gt;value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ht-&gt;base_size = new_ht-&gt;base_size;</span><br><span class="line">    ht-&gt;count = new_ht-&gt;count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//吧 new_ht 和 ht 的 size 交换,(旧 size 在一会释放的时候还有用所以不能丢)</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> tmp_size = ht-&gt;size;</span><br><span class="line">    ht-&gt;size = new_ht-&gt;size;</span><br><span class="line">    new_ht-&gt;size = tmp_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//吧 new_ht 和 ht 的 tmp_items 指针交换(然后就相当于原来的ht换到了大空间了)</span></span><br><span class="line">    ht_item** tmp_items = ht-&gt;items;</span><br><span class="line">    ht-&gt;items = new_ht-&gt;items;</span><br><span class="line">    new_ht-&gt;items = tmp_items;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//new_ht 隐退,深藏功与名</span></span><br><span class="line">    ht_del_hash_table(new_ht);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//此函数也只是作为 insert 时候可能使用的一个util</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ht_resize_up</span><span class="params">(ht_hash_table *ht)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> new_size = ht-&gt;base_size * <span class="number">2</span>;</span><br><span class="line">    ht_resize(ht, new_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//此函数也只是作为 delete 时候可能使用的一个util</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ht_resize_down</span><span class="params">(ht_hash_table *ht)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> new_size = ht-&gt;base_size / <span class="number">2</span>;</span><br><span class="line">    ht_resize(ht, new_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">ht_insert</span><span class="params">(ht_hash_table *ht, <span class="keyword">const</span> <span class="keyword">char</span> *key, <span class="keyword">void</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *oldvalue = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> load = ht-&gt;count * <span class="number">100</span> / ht-&gt;size;</span><br><span class="line">    <span class="keyword">if</span> (load &gt; <span class="number">70</span>)        <span class="comment">//&gt;0.7 就 resize hash table</span></span><br><span class="line">    &#123;</span><br><span class="line">        ht_resize_up(ht);</span><br><span class="line">    &#125;</span><br><span class="line">    ht_item *item = ht_new_item(key, value);</span><br><span class="line">    <span class="keyword">if</span>(!item)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> index = ht_get_hash(item-&gt;key, ht-&gt;size, <span class="number">0</span>);</span><br><span class="line">    ht_item *cur_item = ht-&gt;items[index];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (cur_item != <span class="literal">NULL</span> &amp;&amp; cur_item != &amp;HT_DELETED_ITEM)        <span class="comment">//这个坑已经被占了,说明发生了冲突</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(cur_item-&gt;key, key) == <span class="number">0</span>)        <span class="comment">//插入相同的key被视为更新</span></span><br><span class="line">        &#123;</span><br><span class="line">            oldvalue = cur_item-&gt;value;</span><br><span class="line">            ht_del_item(cur_item);                <span class="comment">//</span></span><br><span class="line">            ht-&gt;items[index] = item;        <span class="comment">//</span></span><br><span class="line">            <span class="keyword">return</span> oldvalue;        <span class="comment">//如果发现返回值 非 NULL,应该立刻执行对 value 的释放操作!不然刚刚的覆盖会引起内存泄漏</span></span><br><span class="line">        &#125;</span><br><span class="line">        index = ht_get_hash(item-&gt;key, ht-&gt;size, i);</span><br><span class="line">        cur_item = ht-&gt;items[index];</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//走到这里说明终于找到了一个新的坑</span></span><br><span class="line">    ht-&gt;items[index] = item;</span><br><span class="line">    ht-&gt;count++;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">ht_search</span><span class="params">(ht_hash_table *ht, <span class="keyword">const</span> <span class="keyword">char</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> index = ht_get_hash(key, ht-&gt;size, <span class="number">0</span>);        <span class="comment">//首次hash拿到的index</span></span><br><span class="line">    ht_item* item = ht-&gt;items[index];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (item != <span class="literal">NULL</span> &amp;&amp; item != &amp;HT_DELETED_ITEM)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(item-&gt;key, key) == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> item-&gt;value;        <span class="comment">//找到了,成功返回</span></span><br><span class="line">        &#125;</span><br><span class="line">        index = ht_get_hash(key, ht-&gt;size, i);        <span class="comment">//没找到,那么看是否因为hash冲突被安排到了下个hash index处</span></span><br><span class="line">        item = ht-&gt;items[index];</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果key-value对不在hash表中,则本函数啥也不做</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ht_delete</span><span class="params">(ht_hash_table *ht, <span class="keyword">const</span> <span class="keyword">char</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> load = ht-&gt;count * <span class="number">100</span> / ht-&gt;size;</span><br><span class="line">    <span class="keyword">if</span> (load &lt; <span class="number">10</span>)        <span class="comment">//&lt;0.1 就 resize hash table</span></span><br><span class="line">    &#123;</span><br><span class="line">        ht_resize_down(ht);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> index = ht_get_hash(key, ht-&gt;size, <span class="number">0</span>);</span><br><span class="line">    ht_item* item = ht-&gt;items[index];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//item本身并不会从数组中被删除(不然会影响冲突链的查找),而是指向 HT_DELETED_ITEM 即表示删除了</span></span><br><span class="line">    <span class="keyword">while</span> (item != <span class="literal">NULL</span>)        <span class="comment">//这里 item==&amp;HT_DELETED_ITEM 也应该是允许的,因为被删除的元素在 冲突链 上位置并不确定</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(item != &amp;HT_DELETED_ITEM)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(item-&gt;key, key) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                ht_del_item(item);</span><br><span class="line">                ht-&gt;items[index] = &amp;HT_DELETED_ITEM;        <span class="comment">//成功删除</span></span><br><span class="line">                ht-&gt;count--;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        index = ht_get_hash(key, ht-&gt;size, i);</span><br><span class="line">        item = ht-&gt;items[index];</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ht_hash_table *<span class="title">ht_new</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ht_new_sized(HT_INITIAL_BASE_SIZE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ht_del_hash_table</span><span class="params">(ht_hash_table *ht)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ht-&gt;size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ht_item* item = ht-&gt;items[i];</span><br><span class="line">        <span class="keyword">if</span> (item != <span class="literal">NULL</span> &amp;&amp; item != &amp;HT_DELETED_ITEM)        <span class="comment">//</span></span><br><span class="line">        &#123;</span><br><span class="line">            ht_del_item(item);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(ht-&gt;items);</span><br><span class="line">    <span class="built_in">free</span>(ht);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ht_map</span><span class="params">(ht_hash_table *ht,<span class="keyword">void</span> apply(<span class="keyword">const</span> <span class="keyword">char</span> *key,<span class="keyword">void</span> **value,<span class="keyword">void</span> *cl),<span class="keyword">void</span> *cl)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ht-&gt;size; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ht_item* item = ht-&gt;items[i];</span><br><span class="line">        <span class="keyword">if</span> (item != <span class="literal">NULL</span> &amp;&amp; item != &amp;HT_DELETED_ITEM)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//printf("%d (%s,%p)\n",i,item-&gt;key,item-&gt;value);</span></span><br><span class="line">            apply(item-&gt;key,&amp;item-&gt;value,cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试这个hash表的时候发现hash函数对插入key为有规律的string的时候性能并不好。hash表还有另一种实现是开链法，将冲突的element链成一个list。<br><img src="/2019/02/11/hash-table/img01.png" alt="hash表开链法实现"></p>
<p>hash表的关键点：</p>
<ul>
<li>为了使hash取得较好的效率一般都是<strong>动态伸缩 hash表 bucket的size</strong>，即当 insert 导致size 超过某个阈值则需resize（不然冲突链过长会导致hash性能下降）。如何resize？简单粗暴的采取”再新建一个bucket表–&gt;将原表中所有node挨个重新插入到新表中” 会出现问题：数据量巨大时，某一次节点插入耗时将很长! 一致性hash？貌似实现起来有点复杂。《redis设计与实现》提到 redis 采用两张 bucket（主bucket0，副bucket1），当需要rehash时 每次插入、删除、查找会顺带将一些主bucket0中的元素rehash 到 bucket1，同时hash manager结构体会记录主bucket0 rehash到哪个index了，总会有全部rehash完毕的时候嘛，那时候再释放bucket0，并将 bucket1–&gt;bucket0。<br><img src="/2019/02/11/hash-table/img02.png" alt="hash表动态rehash"></li>
<li>hash表数据类型的安全。k一定是string吗？hash表是将 XXX 杂糅成 hash_index，XXX 可不一定是 string。v同样可以是某个基本类型或指向某个复杂struct的指针。处理不好会crash或者内存泄漏。redis要求提供keyDup、valDup、keyDestruct、valDestruct等函数。可以很好解决这个问题。</li>
<li>hash函数的选择。上面的hash表实现之所以性能出现问题和我的测试用例密不可分。我在插入数据的时候都是一些有规律的string，比如key_0, key_1, …..直接导致其冲突链表过长。redis采用的murmurhash函数，貌似这个函数被很多开源代码采用，对有规律的key表现出色。当然这个murmurhash只是最好是一个default hash函数，可以替换的。</li>
</ul>
<p>所以我借鉴redis的思想自己实现hash表。目前测试起来性能还可以，后面有bug再修吧<br>目前发现一个问题：缺少一个接口：对hash表中原有(k,v)对进行 v++ 或者 v– 的操作</p>
<h2 id="4-参考redis的hash-table实现"><a href="#4-参考redis的hash-table实现" class="headerlink" title="4. 参考redis的hash table实现"></a>4. 参考redis的hash table实现</h2><p>hashtable.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __HASH_TABLE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __HASH_TABLE_H</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">htItem</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">htItem</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">void</span> *key;</span><br><span class="line">    <span class="keyword">void</span> *val;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hashVal;</span><br><span class="line">&#125; htItem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="title">int</span> <span class="params">(*hashFunc)</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span>;    <span class="comment">//hash 函数</span></span><br><span class="line">    <span class="keyword">int</span> (*keyCmp)(<span class="keyword">const</span> <span class="keyword">void</span> *p1,<span class="keyword">const</span> <span class="keyword">void</span> *p2);    <span class="comment">//key 比较函数</span></span><br><span class="line">    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">const</span> <span class="keyword">void</span> *key);                <span class="comment">//key 复制函数</span></span><br><span class="line">    <span class="keyword">void</span> *(*valDup)(<span class="keyword">const</span> <span class="keyword">void</span> *val);                <span class="comment">//val 复制函数</span></span><br><span class="line">    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *key);                <span class="comment">//key 销毁</span></span><br><span class="line">    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *val);                <span class="comment">//val 销毁</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size0;        <span class="comment">//size = 2^i</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> size1;        <span class="comment">//size = 2^i</span></span><br><span class="line">    htItem** tb0;</span><br><span class="line">    htItem** tb1;</span><br><span class="line">    <span class="keyword">int</span> rehash_index;    <span class="comment">//非-1表示正在做rehash</span></span><br><span class="line">&#125; htManager;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span> *key;</span><br><span class="line">    <span class="keyword">void</span> *val;</span><br><span class="line">&#125; pair;</span><br><span class="line"></span><br><span class="line"><span class="function">htManager *<span class="title">htCreate</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> baseSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> (*hashFunc)(<span class="keyword">const</span> <span class="keyword">void</span> *key),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">int</span> (*keyCmp)(<span class="keyword">const</span> <span class="keyword">void</span> *p1,<span class="keyword">const</span> <span class="keyword">void</span> *p2),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">const</span> <span class="keyword">void</span> *key),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> *(*valDup)(<span class="keyword">const</span> <span class="keyword">void</span> *val),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *key),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *val))</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">htInsert</span><span class="params">(htManager *pht,<span class="keyword">const</span> <span class="keyword">void</span> *key,<span class="keyword">const</span> <span class="keyword">void</span> *val,<span class="keyword">void</span> **oldVal)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">htDelete</span><span class="params">(htManager *pht,<span class="keyword">const</span> <span class="keyword">void</span> *key,<span class="keyword">void</span> **pVal)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">htSearch</span><span class="params">(htManager *pht,<span class="keyword">const</span> <span class="keyword">void</span> *key,<span class="keyword">void</span> **pVal)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">htToPairArray</span><span class="params">(htManager *pht,pair **pairArray,<span class="keyword">int</span> pairCmp(<span class="keyword">const</span> <span class="keyword">void</span> *p1,<span class="keyword">const</span> <span class="keyword">void</span> *p2))</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">htDestroy</span><span class="params">(htManager *pht)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debugHt</span><span class="params">(htManager *pht)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>hashtable.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//rehash_index 表示 rehash到的index,为-1表示没有在做rehash或者rehash完成</span></span><br><span class="line"><span class="comment">//当正在rehash的时候,搜索、插入、删除需要tb0和tb1都要查看,</span></span><br><span class="line"><span class="comment">//当rehash_index&gt;=tb0.size的时候表示rehash已经完成,此时应该</span></span><br><span class="line"><span class="comment">//释放tb0,使用tb1代替tb0,并 rehash_index=-1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hashTable.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//size is at least 2^HT_BASE_SIZE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HT_BASE_SIZE 5</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">murMurHash</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key,<span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> m = <span class="number">0x5bd1e995</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> r = <span class="number">24</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> seed = <span class="number">97</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> h = seed ^ len;</span><br><span class="line">    <span class="comment">// Mix 4 bytes at a time into the hash</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *data = (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *)key;</span><br><span class="line">    <span class="keyword">while</span>(len &gt;= <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> k = *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)data;</span><br><span class="line">        k *= m;</span><br><span class="line">        k ^= k &gt;&gt; r;</span><br><span class="line">        k *= m;</span><br><span class="line">        h *= m;</span><br><span class="line">        h ^= k;</span><br><span class="line">        data += <span class="number">4</span>;</span><br><span class="line">        len -= <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Handle the last few bytes of the input array</span></span><br><span class="line">    <span class="keyword">switch</span>(len)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>: h ^= data[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>: h ^= data[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>: h ^= data[<span class="number">0</span>];</span><br><span class="line">        h *= m;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Do a few final mixes of the hash to ensure the last few</span></span><br><span class="line">    <span class="comment">// bytes are well-incorporated.</span></span><br><span class="line">    h ^= h &gt;&gt; <span class="number">13</span>;</span><br><span class="line">    h *= m;</span><br><span class="line">    h ^= h &gt;&gt; <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">hashFuncDefault</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len = <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)key);</span><br><span class="line">    <span class="keyword">return</span> murMurHash(key,len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">keyCmpDefault</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *p1,<span class="keyword">const</span> <span class="keyword">void</span> *p2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//return ((unsigned int)p1 - (unsigned int)p2);    //默认是按照 key 指针值排序(即key的地址值)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strcmp</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)p1,(<span class="keyword">const</span> <span class="keyword">char</span> *)p2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">keyDupDefault</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len = <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)key);</span><br><span class="line">    <span class="keyword">char</span> *p = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(len+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(p)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(p,<span class="number">0</span>,len+<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(p,key,len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">valDupDefault</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">keyDestructorDefault</span><span class="params">(<span class="keyword">void</span> *key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(key)</span><br><span class="line">        <span class="built_in">free</span>(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">valDestructorDefault</span><span class="params">(<span class="keyword">void</span> *val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    val = val;    <span class="comment">//just tell compiler not to report warning</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> htItem *<span class="title">pickHeadFromCollisionList</span><span class="params">(htItem **bucketTbl,<span class="keyword">unsigned</span> <span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    htItem **ppHead = &amp;bucketTbl[index];</span><br><span class="line">    htItem *pCurItem = *ppHead;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pCurItem)</span><br><span class="line">        *ppHead = pCurItem-&gt;next;</span><br><span class="line">    <span class="keyword">return</span> pCurItem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">linkToHeadOfCollisionList</span><span class="params">(htItem **bucketTbl,<span class="keyword">unsigned</span> <span class="keyword">int</span> index,htItem *pitem)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    htItem **ppHead = &amp;bucketTbl[index];</span><br><span class="line">    pitem-&gt;next = *ppHead;</span><br><span class="line">    *ppHead = pitem;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">rehashOnTheGo</span><span class="params">(htManager *pht,<span class="keyword">unsigned</span> <span class="keyword">int</span> tryCnt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//increase rehash index on the go.</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> rehashElemCnt = <span class="number">0</span>;</span><br><span class="line">    htItem *pCurItem = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;rehash_index &lt; <span class="number">0</span> || pht-&gt;rehash_index &gt;= pht-&gt;size0)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((pht-&gt;rehash_index &lt; pht-&gt;size0) &amp;&amp; rehashElemCnt&lt;tryCnt)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(pht-&gt;tb0[pht-&gt;rehash_index])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//rehash this collision list</span></span><br><span class="line">            <span class="keyword">while</span>((pCurItem = pickHeadFromCollisionList(pht-&gt;tb0,pht-&gt;rehash_index)) != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                linkToHeadOfCollisionList(pht-&gt;tb1,(pCurItem-&gt;hashVal) &amp; (pht-&gt;size1 - <span class="number">1</span>),pCurItem);</span><br><span class="line">                rehashElemCnt++;</span><br><span class="line">            &#125;</span><br><span class="line">            pht-&gt;rehash_index++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            pht-&gt;rehash_index++;</span><br><span class="line">            rehashElemCnt++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;rehash_index &gt;= pht-&gt;size0)    <span class="comment">//means rehash has completed!</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//destroy tb0 and tb1-&gt;tb0</span></span><br><span class="line">        <span class="built_in">free</span>(pht-&gt;tb0);</span><br><span class="line">        pht-&gt;tb0 = pht-&gt;tb1;</span><br><span class="line">        pht-&gt;size0 = pht-&gt;size1;</span><br><span class="line">        pht-&gt;tb1 = <span class="literal">NULL</span>;</span><br><span class="line">        pht-&gt;size1 = <span class="number">0</span>;</span><br><span class="line">        pht-&gt;rehash_index = <span class="number">-1</span>;    <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">htManager *<span class="title">htCreate</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> baseSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">unsigned</span> <span class="keyword">int</span> (*hashFunc)(<span class="keyword">const</span> <span class="keyword">void</span> *key),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">int</span> (*keyCmp)(<span class="keyword">const</span> <span class="keyword">void</span> *p1,<span class="keyword">const</span> <span class="keyword">void</span> *p2),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> *(*keyDup)(<span class="keyword">const</span> <span class="keyword">void</span> *key),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> *(*valDup)(<span class="keyword">const</span> <span class="keyword">void</span> *val),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> (*keyDestructor)(<span class="keyword">void</span> *key),</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">void</span> (*valDestructor)(<span class="keyword">void</span> *val))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    htManager *pht = (htManager *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(htManager));</span><br><span class="line">    <span class="keyword">if</span>(!pht)</span><br><span class="line">        <span class="keyword">goto</span> FAIL_1;</span><br><span class="line"></span><br><span class="line">    pht-&gt;hashFunc = (hashFunc)?hashFunc:hashFuncDefault;</span><br><span class="line">    pht-&gt;keyCmp = (keyCmp)?keyCmp:keyCmpDefault;</span><br><span class="line">    pht-&gt;keyDup = (keyDup)?keyDup:keyDupDefault;</span><br><span class="line">    pht-&gt;valDup = (valDup)?valDup:valDupDefault;</span><br><span class="line">    pht-&gt;keyDestructor = (keyDestructor)?keyDestructor:keyDestructorDefault;</span><br><span class="line">    pht-&gt;valDestructor = (valDestructor)?valDestructor:valDestructorDefault;</span><br><span class="line">    <span class="keyword">if</span>(keyDup &amp;&amp; !hashFunc)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//如果使用 hashFuncDefault 那就最好也使用默认的 strdup</span></span><br><span class="line">        <span class="comment">//WARNING</span></span><br><span class="line">    &#125;</span><br><span class="line">    pht-&gt;count = <span class="number">0</span>;</span><br><span class="line">    pht-&gt;rehash_index = <span class="number">-1</span>;</span><br><span class="line">    pht-&gt;size1 = <span class="number">0</span>;</span><br><span class="line">    pht-&gt;tb1 = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=HT_BASE_SIZE; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">1</span>&lt;&lt;i) &lt; baseSize; i++)</span><br><span class="line">        ;</span><br><span class="line">    pht-&gt;size0 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">1</span>&lt;&lt;i);</span><br><span class="line">    pht-&gt;tb0 = (htItem **)<span class="built_in">malloc</span>((pht-&gt;size0)*<span class="keyword">sizeof</span>(htItem *));</span><br><span class="line">    <span class="keyword">if</span>(!(pht-&gt;tb0))</span><br><span class="line">        <span class="keyword">goto</span> FAIL_2;</span><br><span class="line">    <span class="built_in">memset</span>(pht-&gt;tb0,<span class="number">0</span>,(pht-&gt;size0)*<span class="keyword">sizeof</span>(htItem *));</span><br><span class="line">    <span class="keyword">return</span> pht;</span><br><span class="line"></span><br><span class="line">FAIL_2:</span><br><span class="line">    <span class="built_in">free</span>(pht);</span><br><span class="line">FAIL_1:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">htInsert</span><span class="params">(htManager *pht,<span class="keyword">const</span> <span class="keyword">void</span> *key,<span class="keyword">const</span> <span class="keyword">void</span> *val,<span class="keyword">void</span> **oldVal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    htItem *pItemNew = <span class="literal">NULL</span>;</span><br><span class="line">    htItem **ppHead = <span class="literal">NULL</span>;</span><br><span class="line">    htItem *pCurItem = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hashVal = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> indexInTb0 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> indexInTb1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> updateFlag = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(!pht)</span><br><span class="line">        <span class="keyword">goto</span> FAIL;</span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;rehash_index &lt; <span class="number">0</span>)    <span class="comment">//we do expand/shrink only when we are not doing rehash</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> load = (pht-&gt;count*<span class="number">100</span>)/(pht-&gt;size0);</span><br><span class="line">        <span class="keyword">if</span>(load &gt;= <span class="number">100</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> newi = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(newi = HT_BASE_SIZE; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">1</span>&lt;&lt;newi) &lt; (<span class="number">2</span> * pht-&gt;count); newi++)</span><br><span class="line">                ;</span><br><span class="line">            pht-&gt;size1 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">1</span>&lt;&lt;newi);</span><br><span class="line">            pht-&gt;tb1 = (htItem **)<span class="built_in">malloc</span>((pht-&gt;size1)*<span class="keyword">sizeof</span>(htItem *));</span><br><span class="line">            <span class="keyword">if</span>(!(pht-&gt;tb1))</span><br><span class="line">                <span class="keyword">goto</span> FAIL;</span><br><span class="line">            <span class="built_in">memset</span>(pht-&gt;tb1,<span class="number">0</span>,(pht-&gt;size1)*<span class="keyword">sizeof</span>(htItem *));</span><br><span class="line">            pht-&gt;rehash_index = <span class="number">0</span>;    <span class="comment">//a new rehash process has begun~</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hashVal = (*(pht-&gt;hashFunc))(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;rehash_index &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//go to tb0 to insert directly</span></span><br><span class="line">        indexInTb0 = hashVal &amp; (pht-&gt;size0 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">        ppHead = &amp;pht-&gt;tb0[indexInTb0];</span><br><span class="line">        pCurItem = *ppHead;</span><br><span class="line">        updateFlag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(pCurItem)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>((pCurItem-&gt;hashVal == hashVal) &amp;&amp; ((*(pht-&gt;keyCmp))(pCurItem-&gt;key,key) == <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(oldVal)    <span class="comment">//here I dump for you, but you MUST free them yourself</span></span><br><span class="line">                    *oldVal = pCurItem-&gt;val;    <span class="comment">//no need to *oldVal = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span></span><br><span class="line">                <span class="keyword">else</span>        <span class="comment">//you don't care old value, I free them for you.</span></span><br><span class="line">                    (*(pht-&gt;valDestructor))(pCurItem-&gt;val);</span><br><span class="line">                pCurItem-&gt;val = (*(pht-&gt;valDup))(val);    <span class="comment">//update</span></span><br><span class="line">                updateFlag = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pCurItem = pCurItem-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!updateFlag)</span><br><span class="line">        &#123;</span><br><span class="line">            pItemNew = (htItem *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(htItem));</span><br><span class="line">            <span class="keyword">if</span>(!pItemNew)</span><br><span class="line">                <span class="keyword">goto</span> FAIL;</span><br><span class="line">            pItemNew-&gt;key = (*(pht-&gt;keyDup))(key);</span><br><span class="line">            pItemNew-&gt;val = (*(pht-&gt;valDup))(val);</span><br><span class="line">            pItemNew-&gt;hashVal = hashVal;</span><br><span class="line">            pItemNew-&gt;next = *ppHead;</span><br><span class="line">            *ppHead = pItemNew;    <span class="comment">//insert to be the new head</span></span><br><span class="line">            pht-&gt;count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (updateFlag? <span class="number">0</span>:<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1.go to tb0 to find collision list</span></span><br><span class="line">        <span class="comment">//2.if not null, search and rehash list to tb1(then it turn to null)</span></span><br><span class="line">        <span class="comment">//3.if null, turn to tb1 to search</span></span><br><span class="line">        <span class="comment">//4.select one list from rehash_index and rehash (if rehash_index &gt;= tb0.size, free tb0 and tb1-&gt;tb0,</span></span><br><span class="line">        <span class="comment">//  and change rehash_index to -1)</span></span><br><span class="line">        indexInTb0 = hashVal &amp; (pht-&gt;size0 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">        pCurItem = pht-&gt;tb0[indexInTb0];</span><br><span class="line">        updateFlag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(pCurItem)    <span class="comment">//means this collision list has not rehashed</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span>((pCurItem = pickHeadFromCollisionList(pht-&gt;tb0,indexInTb0)) != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>((pCurItem-&gt;hashVal == hashVal) &amp;&amp; ((*(pht-&gt;keyCmp))(pCurItem-&gt;key,key) == <span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(oldVal)    <span class="comment">//here I dump for you, but you MUST free them yourself</span></span><br><span class="line">                        *oldVal = pCurItem-&gt;val;    <span class="comment">//no need to *oldVal = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span></span><br><span class="line">                    <span class="keyword">else</span>        <span class="comment">//you don't care old value, I free them for you.</span></span><br><span class="line">                        (*(pht-&gt;valDestructor))(pCurItem-&gt;val);</span><br><span class="line">                    pCurItem-&gt;val = (*(pht-&gt;valDup))(val);    <span class="comment">//update</span></span><br><span class="line">                    updateFlag = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                indexInTb1 = (pCurItem-&gt;hashVal) &amp; (pht-&gt;size1 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">                linkToHeadOfCollisionList(pht-&gt;tb1,indexInTb1,pCurItem);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!updateFlag)</span><br><span class="line">            &#123;</span><br><span class="line">                pItemNew = (htItem *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(htItem));</span><br><span class="line">                <span class="keyword">if</span>(!pItemNew)</span><br><span class="line">                    <span class="keyword">goto</span> FAIL;</span><br><span class="line">                pItemNew-&gt;key = (*(pht-&gt;keyDup))(key);</span><br><span class="line">                pItemNew-&gt;val = (*(pht-&gt;valDup))(val);</span><br><span class="line">                pItemNew-&gt;hashVal = hashVal;</span><br><span class="line">                indexInTb1 = (pItemNew-&gt;hashVal) &amp; (pht-&gt;size1 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">                linkToHeadOfCollisionList(pht-&gt;tb1,indexInTb1,pItemNew);</span><br><span class="line">                pht-&gt;count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>    <span class="comment">//means this collision list has rehashed to tb1 already (or just a normal null collision list)</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//go to tb1 to insert directly</span></span><br><span class="line">            indexInTb1 = hashVal &amp; (pht-&gt;size1 - <span class="number">1</span>);</span><br><span class="line">            ppHead = &amp;pht-&gt;tb1[indexInTb1];</span><br><span class="line">            pCurItem = *ppHead;</span><br><span class="line">            <span class="keyword">while</span>(pCurItem)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>((pCurItem-&gt;hashVal == hashVal) &amp;&amp; ((*(pht-&gt;keyCmp))(pCurItem-&gt;key,key) == <span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(oldVal)    <span class="comment">//here I dump for you, but you MUST free them yourself</span></span><br><span class="line">                        *oldVal = pCurItem-&gt;val;    <span class="comment">//no need to *oldVal = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span></span><br><span class="line">                    <span class="keyword">else</span>        <span class="comment">//you don't care old value, I free them for you.</span></span><br><span class="line">                        (*(pht-&gt;valDestructor))(pCurItem-&gt;val);</span><br><span class="line">                    pCurItem-&gt;val = (*(pht-&gt;valDup))(val);    <span class="comment">//update</span></span><br><span class="line">                    updateFlag = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                pCurItem = pCurItem-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(!updateFlag)</span><br><span class="line">            &#123;</span><br><span class="line">                pItemNew = (htItem *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(htItem));</span><br><span class="line">                <span class="keyword">if</span>(!pItemNew)</span><br><span class="line">                    <span class="keyword">goto</span> FAIL;</span><br><span class="line">                pItemNew-&gt;key = (*(pht-&gt;keyDup))(key);</span><br><span class="line">                pItemNew-&gt;val = (*(pht-&gt;valDup))(val);</span><br><span class="line">                pItemNew-&gt;hashVal = hashVal;</span><br><span class="line">                pItemNew-&gt;next = *ppHead;</span><br><span class="line">                *ppHead = pItemNew;    <span class="comment">//insert to be the new head</span></span><br><span class="line">                pht-&gt;count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//increase rehash index on the go. try at least 100 operations</span></span><br><span class="line">        rehashOnTheGo(pht,<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">return</span> (updateFlag ? <span class="number">0</span>:<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">FAIL:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">htDelete</span><span class="params">(htManager *pht,<span class="keyword">const</span> <span class="keyword">void</span> *key,<span class="keyword">void</span> **pVal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    htItem *pCurItem = <span class="literal">NULL</span>;</span><br><span class="line">    htItem **ppCurItem = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hashVal = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> indexInTb0 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> indexInTb1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> gotDelItem = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(!pht)</span><br><span class="line">        <span class="keyword">goto</span> FAIL;</span><br><span class="line">    <span class="comment">//we do expand/shrink only when we are not doing rehash</span></span><br><span class="line">    <span class="comment">//if we reached the HT_BASE_SIZE, we do not do shrink.</span></span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;rehash_index &lt; <span class="number">0</span> &amp;&amp; (pht-&gt;size0 &gt; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">1</span>&lt;&lt;HT_BASE_SIZE)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">int</span> load = (pht-&gt;count*<span class="number">100</span>)/(pht-&gt;size0);</span><br><span class="line">        <span class="keyword">if</span>(load &lt;= <span class="number">10</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">int</span> newi = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(newi = HT_BASE_SIZE; (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">1</span>&lt;&lt;newi) &lt; pht-&gt;count; newi++)</span><br><span class="line">                ;</span><br><span class="line">            pht-&gt;size1 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(<span class="number">1</span>&lt;&lt;newi);</span><br><span class="line">            pht-&gt;tb1 = (htItem **)<span class="built_in">malloc</span>((pht-&gt;size1)*<span class="keyword">sizeof</span>(htItem *));</span><br><span class="line">            <span class="keyword">if</span>(!(pht-&gt;tb1))</span><br><span class="line">                <span class="keyword">goto</span> FAIL;</span><br><span class="line">            <span class="built_in">memset</span>(pht-&gt;tb1,<span class="number">0</span>,(pht-&gt;size1)*<span class="keyword">sizeof</span>(htItem *));</span><br><span class="line">            pht-&gt;rehash_index = <span class="number">0</span>;    <span class="comment">//a new rehash process has begun~</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hashVal = (*(pht-&gt;hashFunc))(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;rehash_index &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//go to tb0 to search and delete directly</span></span><br><span class="line">        indexInTb0 = hashVal &amp; (pht-&gt;size0 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">        ppCurItem = &amp;pht-&gt;tb0[indexInTb0];</span><br><span class="line">        gotDelItem = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(*ppCurItem)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(((*ppCurItem)-&gt;hashVal == hashVal) &amp;&amp; ((*(pht-&gt;keyCmp))((*ppCurItem)-&gt;key,key) == <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                pCurItem = *ppCurItem;</span><br><span class="line">                *ppCurItem = (*ppCurItem)-&gt;next;    <span class="comment">//del from collision list</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(pVal)    <span class="comment">//here I dump for you, but you MUST free them yourself</span></span><br><span class="line">                    *pVal = pCurItem-&gt;val;    <span class="comment">//no need to *pVal = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span></span><br><span class="line">                <span class="keyword">else</span>        <span class="comment">//you don't care del value, I free them for you.</span></span><br><span class="line">                    (*(pht-&gt;valDestructor))(pCurItem-&gt;val);</span><br><span class="line">                (*(pht-&gt;keyDestructor))(pCurItem-&gt;key);</span><br><span class="line">                <span class="built_in">free</span>(pCurItem);</span><br><span class="line"></span><br><span class="line">                pht-&gt;count--;</span><br><span class="line">                gotDelItem = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ppCurItem = &amp;((*ppCurItem)-&gt;next);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (gotDelItem ? <span class="number">1</span>:<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1.go to tb0 to find collision list</span></span><br><span class="line">        <span class="comment">//2.if not null, search and rehash list to tb1(then it turn to null)</span></span><br><span class="line">        <span class="comment">//3.if null, turn to tb1 to search</span></span><br><span class="line">        <span class="comment">//4.select one list from rehash_index and rehash (if rehash_index &gt;= tb0.size, free tb0 and tb1-&gt;tb0,</span></span><br><span class="line">        <span class="comment">//  and change rehash_index to -1)</span></span><br><span class="line">        indexInTb0 = hashVal &amp; (pht-&gt;size0 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">        pCurItem = pht-&gt;tb0[indexInTb0];</span><br><span class="line">        <span class="keyword">if</span>(pCurItem)    <span class="comment">//means this collision list has not rehashed</span></span><br><span class="line">        &#123;</span><br><span class="line">            gotDelItem = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>((pCurItem = pickHeadFromCollisionList(pht-&gt;tb0,indexInTb0)) != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>((pCurItem-&gt;hashVal == hashVal) &amp;&amp; ((*(pht-&gt;keyCmp))(pCurItem-&gt;key,key) == <span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(pVal)    <span class="comment">//here I dump for you, but you MUST free them yourself</span></span><br><span class="line">                        *pVal = pCurItem-&gt;val;    <span class="comment">//no need to *pVal = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span></span><br><span class="line">                    <span class="keyword">else</span>        <span class="comment">//you don't care del value, I free them for you.</span></span><br><span class="line">                        (*(pht-&gt;valDestructor))(pCurItem-&gt;val);</span><br><span class="line">                    (*(pht-&gt;keyDestructor))(pCurItem-&gt;key);</span><br><span class="line">                    <span class="built_in">free</span>(pCurItem);</span><br><span class="line"></span><br><span class="line">                    pht-&gt;count--;</span><br><span class="line">                    gotDelItem = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    indexInTb1 = (pCurItem-&gt;hashVal) &amp; (pht-&gt;size1 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">                    linkToHeadOfCollisionList(pht-&gt;tb1,indexInTb1,pCurItem);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>    <span class="comment">//means this collision list has rehashed already</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//go to tb1 to search and delete directly</span></span><br><span class="line">            indexInTb1 = hashVal &amp; (pht-&gt;size1 - <span class="number">1</span>);</span><br><span class="line">            ppCurItem = &amp;pht-&gt;tb1[indexInTb1];</span><br><span class="line">            gotDelItem = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>(*ppCurItem)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(((*ppCurItem)-&gt;hashVal == hashVal) &amp;&amp; ((*(pht-&gt;keyCmp))((*ppCurItem)-&gt;key,key) == <span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    pCurItem = *ppCurItem;</span><br><span class="line">                    *ppCurItem = (*ppCurItem)-&gt;next;    <span class="comment">//del from collision list</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(pVal)    <span class="comment">//here I dump for you, but you MUST free them yourself</span></span><br><span class="line">                        *pVal = pCurItem-&gt;val;    <span class="comment">//no need to *pVal = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span></span><br><span class="line">                    <span class="keyword">else</span>        <span class="comment">//you don't care del value, I free them for you.</span></span><br><span class="line">                        (*(pht-&gt;valDestructor))(pCurItem-&gt;val);</span><br><span class="line">                    (*(pht-&gt;keyDestructor))(pCurItem-&gt;key);</span><br><span class="line">                    <span class="built_in">free</span>(pCurItem);</span><br><span class="line"></span><br><span class="line">                    pht-&gt;count--;</span><br><span class="line">                    gotDelItem = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ppCurItem = &amp;((*ppCurItem)-&gt;next);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//increase rehash index on the go. try 100 times if encounter continues null collision list</span></span><br><span class="line">        rehashOnTheGo(pht,<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">return</span> (gotDelItem ? <span class="number">1</span>:<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">FAIL:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">htSearch</span><span class="params">(htManager *pht,<span class="keyword">const</span> <span class="keyword">void</span> *key,<span class="keyword">void</span> **pVal)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    htItem *pCurItem = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> hashVal = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> indexInTb0 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> indexInTb1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> gotItem = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>(!pht)</span><br><span class="line">        <span class="keyword">goto</span> FAIL;</span><br><span class="line"></span><br><span class="line">    hashVal = (*(pht-&gt;hashFunc))(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;rehash_index &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//go to tb0 to search directly</span></span><br><span class="line">        indexInTb0 = hashVal &amp; (pht-&gt;size0 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">        pCurItem = pht-&gt;tb0[indexInTb0];</span><br><span class="line">        gotItem = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(pCurItem)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>((pCurItem-&gt;hashVal == hashVal) &amp;&amp; ((*(pht-&gt;keyCmp))(pCurItem-&gt;key,key) == <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(pVal)    <span class="comment">//here I dump for you, but you MUST free them yourself</span></span><br><span class="line">                    *pVal = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span><br><span class="line">                gotItem = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            pCurItem = pCurItem-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (gotItem ? <span class="number">1</span>:<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//1.go to tb0 to find collision list</span></span><br><span class="line">        <span class="comment">//2.if not null, search and rehash list to tb1(then it turn to null)</span></span><br><span class="line">        <span class="comment">//3.if null, turn to tb1 to search</span></span><br><span class="line">        <span class="comment">//4.select one list from rehash_index and rehash (if rehash_index &gt;= tb0.size, free tb0 and tb1-&gt;tb0,</span></span><br><span class="line">        <span class="comment">//  and change rehash_index to -1)</span></span><br><span class="line">        indexInTb0 = hashVal &amp; (pht-&gt;size0 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">        pCurItem = pht-&gt;tb0[indexInTb0];</span><br><span class="line">        gotItem = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(pCurItem)    <span class="comment">//means this collision list has not rehashed</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span>((pCurItem = pickHeadFromCollisionList(pht-&gt;tb0,indexInTb0)) != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>((pCurItem-&gt;hashVal == hashVal) &amp;&amp; ((*(pht-&gt;keyCmp))(pCurItem-&gt;key,key) == <span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(pVal)    <span class="comment">//here I dump for you, but you MUST free them yourself</span></span><br><span class="line">                        *pVal = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span><br><span class="line">                    gotItem = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                indexInTb1 = (pCurItem-&gt;hashVal) &amp; (pht-&gt;size1 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">                linkToHeadOfCollisionList(pht-&gt;tb1,indexInTb1,pCurItem);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//go to tb1 to search and delete directly</span></span><br><span class="line">            indexInTb1 = hashVal &amp; (pht-&gt;size1 - <span class="number">1</span>);    <span class="comment">//size mask</span></span><br><span class="line">            pCurItem = pht-&gt;tb1[indexInTb1];</span><br><span class="line">            <span class="keyword">while</span>(pCurItem)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>((pCurItem-&gt;hashVal == hashVal) &amp;&amp; ((*(pht-&gt;keyCmp))(pCurItem-&gt;key,key) == <span class="number">0</span>))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span>(pVal)    <span class="comment">//here I dump for you, but you MUST free them yourself</span></span><br><span class="line">                        *pVal = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span><br><span class="line">                    gotItem = <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                pCurItem = pCurItem-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        rehashOnTheGo(pht,<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">return</span> (gotItem ? <span class="number">1</span>:<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">FAIL:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//int htPairArrayGet(htManager *pht,pair **pairArray,int pairCmp(const void *p1,const void *p2))</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">htToPairArray</span><span class="params">(htManager *pht,pair **pairArray,<span class="keyword">int</span> pairCmp(<span class="keyword">const</span> <span class="keyword">void</span> *p1,<span class="keyword">const</span> <span class="keyword">void</span> *p2))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    pair *kv = <span class="literal">NULL</span>;</span><br><span class="line">    htItem *pCurItem = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!pht || pht-&gt;count &lt;= <span class="number">0</span> || !pairArray)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    kv = (pair *)<span class="built_in">malloc</span>((pht-&gt;count)*<span class="keyword">sizeof</span>(pair));</span><br><span class="line">    <span class="keyword">if</span>(!kv)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;tb0)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(index=<span class="number">0</span>; index &lt; pht-&gt;size0 &amp;&amp; count &lt; pht-&gt;count; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//search collision list</span></span><br><span class="line">            pCurItem = pht-&gt;tb0[index];</span><br><span class="line">            <span class="keyword">while</span>(pCurItem)</span><br><span class="line">            &#123;</span><br><span class="line">                kv[count].key = (*(pht-&gt;keyDup))(pCurItem-&gt;key);</span><br><span class="line">                kv[count].val = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span><br><span class="line">                count++;</span><br><span class="line">                pCurItem = pCurItem-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//count hold ...</span></span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;tb1)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(index=<span class="number">0</span>; index &lt; pht-&gt;size1 &amp;&amp; count &lt; pht-&gt;count; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//search collision list</span></span><br><span class="line">            pCurItem = pht-&gt;tb1[index];</span><br><span class="line">            <span class="keyword">while</span>(pCurItem)</span><br><span class="line">            &#123;</span><br><span class="line">                kv[count].key = (*(pht-&gt;keyDup))(pCurItem-&gt;key);</span><br><span class="line">                kv[count].val = (*(pht-&gt;valDup))(pCurItem-&gt;val);</span><br><span class="line">                count++;</span><br><span class="line">                pCurItem = pCurItem-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pairCmp)    <span class="comment">//1 待排序数组首地址 2 数组中待排序元素数量 3 各元素的占用空间大小 4 指向函数的指针</span></span><br><span class="line">        qsort(kv,pht-&gt;count,<span class="keyword">sizeof</span>(kv[<span class="number">0</span>]),pairCmp);</span><br><span class="line">    *pairArray = kv;</span><br><span class="line">    <span class="keyword">return</span> pht-&gt;count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* if this put function not provide, you MUST know how to proper free kv array!</span></span><br><span class="line"><span class="comment">int htPairArrayPut(htManager *pht,pair *pairArray)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">    unsigned int i=0;</span></span><br><span class="line"><span class="comment">    if(!pht || pht-&gt;count &lt;= 0 || !pairArray)</span></span><br><span class="line"><span class="comment">        return -1;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    for(i=0;i&lt;pht-&gt;count;i++)</span></span><br><span class="line"><span class="comment">    &#123;</span></span><br><span class="line"><span class="comment">        (*(pht-&gt;keyDestructor))(pairArray[i].key);</span></span><br><span class="line"><span class="comment">        (*(pht-&gt;valDestructor))(pairArray[i].val);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    free(pairArray);</span></span><br><span class="line"><span class="comment">    return 0;</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">htDestroy</span><span class="params">(htManager *pht)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">    htItem *pHead = <span class="literal">NULL</span>;</span><br><span class="line">    htItem *pCurItem = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(!pht)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;tb0)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(index=<span class="number">0</span>; index&lt;pht-&gt;size0 &amp;&amp; pht-&gt;count &gt; <span class="number">0</span>; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//search collision list</span></span><br><span class="line">            pHead = pht-&gt;tb0[index];</span><br><span class="line">            pCurItem = pHead;</span><br><span class="line">            <span class="keyword">while</span>(pCurItem)</span><br><span class="line">            &#123;</span><br><span class="line">                pHead = pCurItem-&gt;next;</span><br><span class="line"></span><br><span class="line">                (*(pht-&gt;keyDestructor))(pCurItem-&gt;key);</span><br><span class="line">                (*(pht-&gt;valDestructor))(pCurItem-&gt;val);</span><br><span class="line">                <span class="built_in">free</span>(pCurItem);</span><br><span class="line"></span><br><span class="line">                pht-&gt;count--;</span><br><span class="line">                pCurItem = pHead;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(pht-&gt;tb0);</span><br><span class="line">        pht-&gt;size0 = <span class="number">0</span>;</span><br><span class="line">        pht-&gt;tb0 = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;tb1)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(index=<span class="number">0</span>; index&lt;pht-&gt;size1 &amp;&amp; pht-&gt;count &gt; <span class="number">0</span>; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//search collision list</span></span><br><span class="line">            pHead = pht-&gt;tb1[index];</span><br><span class="line">            pCurItem = pHead;</span><br><span class="line">            <span class="keyword">while</span>(pCurItem)</span><br><span class="line">            &#123;</span><br><span class="line">                pHead = pCurItem-&gt;next;</span><br><span class="line"></span><br><span class="line">                (*(pht-&gt;keyDestructor))(pCurItem-&gt;key);</span><br><span class="line">                (*(pht-&gt;valDestructor))(pCurItem-&gt;val);</span><br><span class="line">                <span class="built_in">free</span>(pCurItem);</span><br><span class="line"></span><br><span class="line">                pht-&gt;count--;</span><br><span class="line">                pCurItem = pHead;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">free</span>(pht-&gt;tb1);</span><br><span class="line">        pht-&gt;size1 = <span class="number">0</span>;</span><br><span class="line">        pht-&gt;tb1 = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(pht);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//============== for DEBUG =================</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">collisionListLen</span><span class="params">(htItem *pHead)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    htItem *pCurItem = pHead;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(pCurItem)</span><br><span class="line">    &#123;</span><br><span class="line">        len++;</span><br><span class="line">        pCurItem = pCurItem-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">debugHt</span><span class="params">(htManager *pht)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">    htItem *pHead = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> maxLen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> *stat = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;tb0)</span><br><span class="line">    &#123;</span><br><span class="line">        maxLen = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(index=<span class="number">0</span>; index&lt;pht-&gt;size0; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            pHead = pht-&gt;tb0[index];</span><br><span class="line">            <span class="keyword">if</span>((tmp = collisionListLen(pHead)) &gt; maxLen)</span><br><span class="line">                maxLen = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">        stat = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>((maxLen+<span class="number">1</span>)*<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(index=<span class="number">0</span>; index&lt;pht-&gt;size0; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            pHead = pht-&gt;tb0[index];</span><br><span class="line">            stat[collisionListLen(pHead)]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"tb0 stat:(%u/%u),max collision len %u\n"</span>,pht-&gt;count,pht-&gt;size0,maxLen);</span><br><span class="line">        <span class="keyword">for</span>(index=<span class="number">0</span>;index&lt;=maxLen;index++)</span><br><span class="line">        &#123;</span><br><span class="line">            sum += index * stat[index];</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"len %u (%u lists)\n"</span>,index,stat[index]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"calculated sum = %u\n"</span>,sum);</span><br><span class="line">        <span class="built_in">free</span>(stat);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(pht-&gt;tb1)</span><br><span class="line">    &#123;</span><br><span class="line">        maxLen = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(index=<span class="number">0</span>; index&lt;pht-&gt;size1; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            pHead = pht-&gt;tb1[index];</span><br><span class="line">            <span class="keyword">if</span>((tmp = collisionListLen(pHead)) &gt; maxLen)</span><br><span class="line">                maxLen = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">        stat = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>((maxLen+<span class="number">1</span>)*<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(index=<span class="number">0</span>; index&lt;pht-&gt;size1; index++)</span><br><span class="line">        &#123;</span><br><span class="line">            pHead = pht-&gt;tb1[index];</span><br><span class="line">            stat[collisionListLen(pHead)]++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"tb1 stat:(%u/%u),max collision len %u\n"</span>,pht-&gt;count,pht-&gt;size1,maxLen);</span><br><span class="line">        <span class="keyword">for</span>(index=<span class="number">0</span>;index&lt;=maxLen;index++)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"len %u (%u lists)\n"</span>,index,stat[index]);</span><br><span class="line">        <span class="built_in">free</span>(stat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>test.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hashTable.h"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hashTable_test1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">//char *v = NULL;</span></span><br><span class="line">    <span class="keyword">char</span> k[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"======================================================\n"</span>);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">200</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(k,<span class="string">"key_%d"</span>,i);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,k);</span><br><span class="line">    &#125;</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="comment">//i=100000;</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        htManager *pht = htCreate(<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">//printf("htCreate ..\n");</span></span><br><span class="line">        <span class="comment">//usleep(1000000);</span></span><br><span class="line"></span><br><span class="line">        htDestroy(pht);</span><br><span class="line">        pht = <span class="literal">NULL</span>;</span><br><span class="line">        usleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">//printf("htDestroy \n");</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hashTable_test2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> del_num[]=&#123;<span class="number">984</span>,<span class="number">23</span>,<span class="number">444</span>,<span class="number">678</span>,<span class="number">2550</span>,<span class="number">3486</span>,<span class="number">23</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> reInsert_num[]=&#123;<span class="number">55</span>,<span class="number">3905</span>,<span class="number">344</span>,<span class="number">2550</span>,<span class="number">3486</span>,<span class="number">23</span>&#125;;</span><br><span class="line">    <span class="keyword">void</span> *val_temp=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">    htManager *pht = htCreate(<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">//char *v = NULL;</span></span><br><span class="line">    <span class="keyword">char</span> k[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* insert test */</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">2560</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(k,<span class="string">"key_%d"</span>,i);</span><br><span class="line">        res = htInsert(pht,k,(<span class="keyword">const</span> <span class="keyword">void</span> *)i,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ins(%s,%d)\n"</span>,k,i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"update a value ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ins fail ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"insert ok, wait for continue\n"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* insert a exist element test */</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="keyword">sizeof</span>(reInsert_num)/<span class="keyword">sizeof</span>(reInsert_num[<span class="number">0</span>]);i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(k,<span class="string">"key_%d"</span>,reInsert_num[i]);</span><br><span class="line">        res = htInsert(pht,k,(<span class="keyword">const</span> <span class="keyword">void</span> *)<span class="number">250</span>,&amp;val_temp);</span><br><span class="line">        <span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ins(%s,%d)\n"</span>,k,i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"update a value k is %s,origin val is %d,wait for confirm\n"</span>,k,(<span class="keyword">int</span>)val_temp);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ins fail ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"insert ok, wait for continue\n"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* delete test */</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="keyword">sizeof</span>(del_num)/<span class="keyword">sizeof</span>(del_num[<span class="number">0</span>]);i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(k,<span class="string">"key_%d"</span>,del_num[i]);</span><br><span class="line">        res = htDelete(pht,k,&amp;val_temp);</span><br><span class="line">        <span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"del a element ok, k is %s,v is %d\n"</span>,k,(<span class="keyword">int</span>)val_temp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"cannot find the emement you want to del(k=%s),need conform"</span>,k);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"htDelete fail ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* search test */</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">2560</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(k,<span class="string">"key_%d"</span>,i);</span><br><span class="line">        res = htSearch(pht,k,&amp;val_temp);</span><br><span class="line">        <span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"got, k is %s,v is %d\n"</span>,k,(<span class="keyword">int</span>)val_temp);</span><br><span class="line">            <span class="keyword">if</span>((<span class="keyword">int</span>)val_temp != i)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"seems this val is not correct,wait for confirm\n"</span>);</span><br><span class="line">                getchar();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"does not find this value? wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"htSearch fail ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"search ok, wait for continue\n"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    <span class="comment">//i=100000;</span></span><br><span class="line">    <span class="comment">//while(1)</span></span><br><span class="line">    <span class="comment">//    usleep(1000);</span></span><br><span class="line">    htDestroy(pht);</span><br><span class="line">    pht = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//============================================================</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *<span class="title">myValDup</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len = <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)val);</span><br><span class="line">    <span class="keyword">char</span> *p = <span class="built_in">malloc</span>(len+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(p)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memset</span>(p,<span class="number">0</span>,len+<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(p,val,len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">myValDestructor</span><span class="params">(<span class="keyword">void</span> *val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">free</span>(val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hashTable_test3</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> del_num[]=&#123;<span class="number">984</span>,<span class="number">23</span>,<span class="number">444</span>,<span class="number">678</span>,<span class="number">2550</span>,<span class="number">3486</span>,<span class="number">23</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> reInsert_num[]=&#123;<span class="number">55</span>,<span class="number">3905</span>,<span class="number">344</span>,<span class="number">2550</span>,<span class="number">3486</span>,<span class="number">23</span>&#125;;</span><br><span class="line">    <span class="keyword">void</span> *val_temp=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">    htManager *pht = htCreate(<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,myValDup,<span class="literal">NULL</span>,myValDestructor);</span><br><span class="line">    <span class="comment">//char *v = NULL;</span></span><br><span class="line">    <span class="keyword">char</span> k[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> v[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* insert test */</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">2560</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(k,<span class="string">"key_%d"</span>,i);</span><br><span class="line">        <span class="built_in">sprintf</span>(v,<span class="string">"value_%d is me~~"</span>,i);</span><br><span class="line">        res = htInsert(pht,k,v,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ins(%s,%s)\n"</span>,k,v);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"update a value? ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ins fail ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"insert ok, wait for continue\n"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* insert a exist element test */</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="keyword">sizeof</span>(reInsert_num)/<span class="keyword">sizeof</span>(reInsert_num[<span class="number">0</span>]);i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(k,<span class="string">"key_%d"</span>,reInsert_num[i]);</span><br><span class="line">        <span class="built_in">sprintf</span>(v,<span class="string">"I am value_%d insert in second wrap..."</span>,reInsert_num[i]);</span><br><span class="line">        res = htInsert(pht,k,v,&amp;val_temp);</span><br><span class="line">        <span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ins(%s,%s)\n"</span>,k,v);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"update a value k is %s,origin val is (%s),wait for confirm\n"</span>,k,(<span class="keyword">char</span> *)val_temp);</span><br><span class="line">            myValDestructor(val_temp);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ins fail ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"insert ok, wait for continue\n"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* delete test */</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="keyword">sizeof</span>(del_num)/<span class="keyword">sizeof</span>(del_num[<span class="number">0</span>]);i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(k,<span class="string">"key_%d"</span>,del_num[i]);</span><br><span class="line">        res = htDelete(pht,k,&amp;val_temp);</span><br><span class="line">        <span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"del a element ok, k is %s,v is %s\n"</span>,k,(<span class="keyword">char</span> *)val_temp);</span><br><span class="line">            myValDestructor(val_temp);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"cannot find the emement you want to del(k=%s),need conform"</span>,k);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"htDelete fail ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* search test */</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">2560</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(k,<span class="string">"key_%d"</span>,i);</span><br><span class="line">        <span class="built_in">sprintf</span>(v,<span class="string">"value_%d is me~~"</span>,i);</span><br><span class="line">        res = htSearch(pht,k,&amp;val_temp);</span><br><span class="line">        <span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"got, k is %s,v is %s\n"</span>,k,(<span class="keyword">char</span> *)val_temp);</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(v,val_temp) != <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"seems this val is not correct,wait for confirm\n"</span>);</span><br><span class="line">                getchar();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"does not find this value? wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"htSearch fail ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"search ok, wait for continue\n"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    debugHt(pht);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//i=100000;</span></span><br><span class="line">    <span class="comment">//while(1)</span></span><br><span class="line">    <span class="comment">//    usleep(1000);</span></span><br><span class="line">    htDestroy(pht);</span><br><span class="line">    pht = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//=====================================================</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">myPairCmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *a1,<span class="keyword">const</span> <span class="keyword">void</span> *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pair *p1 = (pair *)a1;</span><br><span class="line">    pair *p2 = (pair *)a2;</span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">int</span>)(p1-&gt;val) - (<span class="keyword">int</span>)(p2-&gt;val));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">hashTable_test4</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">    htManager *pht = htCreate(<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> k[<span class="number">50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> v=<span class="number">0</span>;</span><br><span class="line">    srand(<span class="number">0</span>); <span class="comment">//生成随机种子</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* insert test */</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">100</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(k,<span class="string">"key_%d"</span>,i);</span><br><span class="line">        v = rand()%<span class="number">100</span>;</span><br><span class="line">        res = htInsert(pht,k,(<span class="keyword">const</span> <span class="keyword">void</span> *)v,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(res == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ins(%s,%d)\n"</span>,k,v);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(res == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"update a value key=%s,val=%d,wait for confirm\n"</span>,k,v);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"ins fail ,wait for confirm\n"</span>);</span><br><span class="line">            getchar();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"insert ok,total %u elements, wait for continue\n"</span>,pht-&gt;count);</span><br><span class="line">    getchar();</span><br><span class="line">    </span><br><span class="line">    pair *pKV = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> pairLen=<span class="number">0</span>;</span><br><span class="line">    pairLen = htToPairArray(pht,&amp;pKV,myPairCmp);</span><br><span class="line">    <span class="comment">//pairLen = htToPairArray(pht,&amp;pKV,NULL);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//then we can even destroy hash table here..,because that kv array has no relationship with hashtable any more</span></span><br><span class="line">    htDestroy(pht);</span><br><span class="line">    pht = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;pairLen;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"(%s,%d)\n"</span>,pKV[i].key,(<span class="keyword">int</span>)pKV[i].val);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;pairLen;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">free</span>(pKV[i].key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(pKV);</span><br><span class="line">    pKV = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"ok.\n"</span>);</span><br><span class="line">    getchar();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-c-中的map"><a href="#5-c-中的map" class="headerlink" title="5. c++中的map"></a>5. c++中的map</h2><p>c++提供了map就不用自己造轮子了, 参考 <a href="https://blog.csdn.net/shuzfan/article/details/53115922" target="_blank" rel="noopener">c++map使用</a></p>

    </article>
    <!-- license  -->
    
        <div class="license-wrapper">
            <p>原文作者：<a href="https://ddddfang.github.io">ddddfang</a>
            </p><p>原文链接：<a href="https://ddddfang.github.io/2019/02/11/hash-table/">https://ddddfang.github.io/2019/02/11/hash-table/</a>
            </p><p>发表日期：<a href="https://ddddfang.github.io/2019/02/11/hash-table/">February 11th 2019, 3:14:22 pm</a>
            </p><p>更新日期：<a href="https://ddddfang.github.io/2019/02/11/hash-table/">February 15th 2019, 3:51:25 pm</a>
            </p><p>版权声明：本文采用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可</p>
        </div>
    
    <!-- paginator  -->
    <ul class="post-paginator">
        <li class="next">
            
                <div class="nextSlogan">Next Post</div>
                <a href="/2019/02/13/max-heap/" title="max-heap">
                    <div class="nextTitle">max-heap</div>
                </a>
            
        </li>
        <li class="previous">
            
                <div class="prevSlogan">Previous Post</div>
                <a href="/2019/02/11/binary-search/" title="binary-search">
                    <div class="prevTitle">binary-search</div>
                </a>
            
        </li>
    </ul>
    <!-- 评论插件 -->
    <!-- 来必力City版安装代码 -->

<!-- City版安装代码已完成 -->
    
    
    <!-- partial('_partial/comment/changyan') -->
    <!--PC版-->


    
    

    <!-- 评论 -->
</main>
            <!-- profile -->
            
        </div>
        <footer class="footer footer-unloaded">
    <!-- social  -->
    
    <div class="social">
        
    
        
            
                <a href="mailto:17621308623@163.com" class="iconfont-archer email" title="email"></a>
            
        
    
        
            
                <a href="https://github.com/ddddfang" class="iconfont-archer github" target="_blank" title="github"></a>
            
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    

    </div>
    
    <!-- powered by Hexo  -->
    <div class="copyright">
        <span id="hexo-power">Powered by <a href="https://hexo.io/" target="_blank">Hexo</a></span><span class="iconfont-archer power">&#xe635;</span><span id="theme-info">theme <a href="https://github.com/fi3ework/hexo-theme-archer" target="_blank">Archer</a></span>
    </div>
    <!-- 不蒜子  -->
    
    <div class="busuanzi-container">
    
     
    <span id="busuanzi_container_site_pv">PV: <span id="busuanzi_value_site_pv"></span> :)</span>
    
    </div>
    
</footer>
    </div>
    <!-- toc -->
    
    <div class="toc-wrapper" style=
    







top:50vh;

    >
        <div class="toc-catalog">
            <span class="iconfont-archer catalog-icon">&#xe613;</span><span>CATALOG</span>
        </div>
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-概述"><span class="toc-number">1.</span> <span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-hash表实现的map和红黑树-or-skiplist-实现的map"><span class="toc-number">2.</span> <span class="toc-text">2. hash表实现的map和红黑树(or skiplist)实现的map</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-一个存在问题的hash-table实现"><span class="toc-number">3.</span> <span class="toc-text">3. 一个存在问题的hash table实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-参考redis的hash-table实现"><span class="toc-number">4.</span> <span class="toc-text">4. 参考redis的hash table实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-c-中的map"><span class="toc-number">5.</span> <span class="toc-text">5. c++中的map</span></a></li></ol>
    </div>
    
    <div class="back-top iconfont-archer">&#xe639;</div>
    <div class="sidebar sidebar-hide">
    <ul class="sidebar-tabs sidebar-tabs-active-0">
        <li class="sidebar-tab-archives"><span class="iconfont-archer">&#xe67d;</span><span class="tab-name">Archive</span></li>
        <li class="sidebar-tab-tags"><span class="iconfont-archer">&#xe61b;</span><span class="tab-name">Tag</span></li>
        <li class="sidebar-tab-categories"><span class="iconfont-archer">&#xe666;</span><span class="tab-name">Cate</span></li>
    </ul>
    <div class="sidebar-content sidebar-content-show-archive">
          <div class="sidebar-panel-archives">
    <!-- 在ejs中将archive按照时间排序 -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    <div class="total-and-search">
        <div class="total-archive">
        Total : 38
        </div>
        <!-- search  -->
        
    </div>
    
    <div class="post-archive">
    
    
    
    
    <div class="archive-year"> 2019 </div>
    <ul class="year-list">
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/18</span><a class="archive-post-title" href="/2019/02/18/cpp-sequential-container/">cpp---sequential-container</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/15</span><a class="archive-post-title" href="/2019/02/15/caffe-ubuntu14-gpu/">caffe-ubuntu14-gpu</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/15</span><a class="archive-post-title" href="/2019/02/15/cpp-key-val-set/">cpp---key-val-set</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/14</span><a class="archive-post-title" href="/2019/02/14/learn-caffe-code/">learn-caffe-code</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/14</span><a class="archive-post-title" href="/2019/02/14/cpp-define/">cpp---define</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/13</span><a class="archive-post-title" href="/2019/02/13/cpp-sort/">cpp---sort</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/13</span><a class="archive-post-title" href="/2019/02/13/max-heap/">max-heap</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/11</span><a class="archive-post-title" href="/2019/02/11/hash-table/">hash-table</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">02/11</span><a class="archive-post-title" href="/2019/02/11/binary-search/">binary-search</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/31</span><a class="archive-post-title" href="/2019/01/31/bit-set/">bit-set</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/31</span><a class="archive-post-title" href="/2019/01/31/gitbook/">gitbook</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href="/2019/01/30/list/">list</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href="/2019/01/30/rb-tree/">rb-tree</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href="/2019/01/30/caffe/">caffe</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href="/2019/01/30/cmake/">cmake</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href="/2019/01/30/docker-apps/">docker-apps</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href="/2019/01/30/printf-可变参数/">printf-可变参数</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href="/2019/01/30/sort-related/">sort-related</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href="/2019/01/30/docker-hub/">docker-hub</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href="/2019/01/30/杂谈/">杂谈</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/30</span><a class="archive-post-title" href="/2019/01/30/docker-file/">docker-file</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/29</span><a class="archive-post-title" href="/2019/01/29/makefile2/">makefile2</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/28</span><a class="archive-post-title" href="/2019/01/28/perforce/">perforce</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/28</span><a class="archive-post-title" href="/2019/01/28/makefile/">makefile</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/28</span><a class="archive-post-title" href="/2019/01/28/static-dynamic-library/">static-dynamic-library</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/28</span><a class="archive-post-title" href="/2019/01/28/使用github/">使用github</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/28</span><a class="archive-post-title" href="/2019/01/28/vim/">vim</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/23</span><a class="archive-post-title" href="/2019/01/23/ubuntu-release/">ubuntu-release</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/23</span><a class="archive-post-title" href="/2019/01/23/dd/">dd</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/23</span><a class="archive-post-title" href="/2019/01/23/disk/">disk ===> fdisk mount df</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/23</span><a class="archive-post-title" href="/2019/01/23/sed/">sed</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/23</span><a class="archive-post-title" href="/2019/01/23/shell/">shell</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/23</span><a class="archive-post-title" href="/2019/01/23/xxd/">xxd</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/22</span><a class="archive-post-title" href="/2019/01/22/gdb/">gdb</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/11</span><a class="archive-post-title" href="/2019/01/11/git/">git</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/11</span><a class="archive-post-title" href="/2019/01/11/docker-basic/">docker-basic</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/03</span><a class="archive-post-title" href="/2019/01/03/ffmpeg学习资料/">ffmpeg学习资料</a>
        </li>
    
    
        <li class="archive-post-item">
            <span class="archive-post-date">01/03</span><a class="archive-post-title" href="/2019/01/03/hexo-blog/">hexo-blog</a>
        </li>
    
    </ul></div>
  </div>
        <div class="sidebar-panel-tags">
    <div class="sidebar-tags-name">
    
        <span class="sidebar-tag-name" data-tags="binary-search"><span class="iconfont-archer">&#xe606;</span>binary-search</span>
    
        <span class="sidebar-tag-name" data-tags="bitmap"><span class="iconfont-archer">&#xe606;</span>bitmap</span>
    
        <span class="sidebar-tag-name" data-tags="caffe"><span class="iconfont-archer">&#xe606;</span>caffe</span>
    
        <span class="sidebar-tag-name" data-tags="c++"><span class="iconfont-archer">&#xe606;</span>c++</span>
    
        <span class="sidebar-tag-name" data-tags="单例模式"><span class="iconfont-archer">&#xe606;</span>单例模式</span>
    
        <span class="sidebar-tag-name" data-tags="common misc"><span class="iconfont-archer">&#xe606;</span>common misc</span>
    
        <span class="sidebar-tag-name" data-tags="makefile"><span class="iconfont-archer">&#xe606;</span>makefile</span>
    
        <span class="sidebar-tag-name" data-tags="宏"><span class="iconfont-archer">&#xe606;</span>宏</span>
    
        <span class="sidebar-tag-name" data-tags="顺序容器"><span class="iconfont-archer">&#xe606;</span>顺序容器</span>
    
        <span class="sidebar-tag-name" data-tags="排序"><span class="iconfont-archer">&#xe606;</span>排序</span>
    
        <span class="sidebar-tag-name" data-tags="shell"><span class="iconfont-archer">&#xe606;</span>shell</span>
    
        <span class="sidebar-tag-name" data-tags="linux command"><span class="iconfont-archer">&#xe606;</span>linux command</span>
    
        <span class="sidebar-tag-name" data-tags="docker"><span class="iconfont-archer">&#xe606;</span>docker</span>
    
        <span class="sidebar-tag-name" data-tags="blog"><span class="iconfont-archer">&#xe606;</span>blog</span>
    
        <span class="sidebar-tag-name" data-tags="gdb"><span class="iconfont-archer">&#xe606;</span>gdb</span>
    
        <span class="sidebar-tag-name" data-tags="ffmpeg"><span class="iconfont-archer">&#xe606;</span>ffmpeg</span>
    
        <span class="sidebar-tag-name" data-tags="gitbook"><span class="iconfont-archer">&#xe606;</span>gitbook</span>
    
        <span class="sidebar-tag-name" data-tags="p4"><span class="iconfont-archer">&#xe606;</span>p4</span>
    
        <span class="sidebar-tag-name" data-tags="printf 可变参数"><span class="iconfont-archer">&#xe606;</span>printf 可变参数</span>
    
        <span class="sidebar-tag-name" data-tags="第k小的数"><span class="iconfont-archer">&#xe606;</span>第k小的数</span>
    
        <span class="sidebar-tag-name" data-tags="static and dynamic library"><span class="iconfont-archer">&#xe606;</span>static and dynamic library</span>
    
        <span class="sidebar-tag-name" data-tags="ubuntu setup"><span class="iconfont-archer">&#xe606;</span>ubuntu setup</span>
    
        <span class="sidebar-tag-name" data-tags="git"><span class="iconfont-archer">&#xe606;</span>git</span>
    
        <span class="sidebar-tag-name" data-tags="draw.io"><span class="iconfont-archer">&#xe606;</span>draw.io</span>
    
        <span class="sidebar-tag-name" data-tags="markdown"><span class="iconfont-archer">&#xe606;</span>markdown</span>
    
        <span class="sidebar-tag-name" data-tags="vscode"><span class="iconfont-archer">&#xe606;</span>vscode</span>
    
        <span class="sidebar-tag-name" data-tags="office2016 密钥"><span class="iconfont-archer">&#xe606;</span>office2016 密钥</span>
    
        <span class="sidebar-tag-name" data-tags="键值对集合"><span class="iconfont-archer">&#xe606;</span>键值对集合</span>
    
        <span class="sidebar-tag-name" data-tags="链表"><span class="iconfont-archer">&#xe606;</span>链表</span>
    
        <span class="sidebar-tag-name" data-tags="最大堆(大顶堆)"><span class="iconfont-archer">&#xe606;</span>最大堆(大顶堆)</span>
    
        <span class="sidebar-tag-name" data-tags="vim"><span class="iconfont-archer">&#xe606;</span>vim</span>
    
        <span class="sidebar-tag-name" data-tags="红黑树"><span class="iconfont-archer">&#xe606;</span>红黑树</span>
    
        <span class="sidebar-tag-name" data-tags="hash-table"><span class="iconfont-archer">&#xe606;</span>hash-table</span>
    
    </div>
    <div class="iconfont-archer sidebar-tags-empty">&#xe678;</div>
    <div class="tag-load-fail" style="display: none; color: #ccc; font-size: 0.6rem;">
    缺失模块。<br>
    1、请确保node版本大于6.2<br>
    2、在博客根目录（注意不是archer根目录）执行以下命令：<br>
    <span style="color: #f75357; font-size: 1rem; line-height: 2rem;">npm i hexo-generator-json-content --save</span><br>
    3、在根目录_config.yml里添加配置：
    <pre style="color: #787878; font-size: 0.6rem;">
jsonContent:
  meta: false
  pages: false
  posts:
    title: true
    date: true
    path: true
    text: false
    raw: false
    content: false
    slug: false
    updated: false
    comments: false
    link: false
    permalink: false
    excerpt: false
    categories: true
    tags: true</pre>
    </div> 
    <div class="sidebar-tags-list"></div>
</div>
        <div class="sidebar-panel-categories">
    <div class="sidebar-categories-name">
    
        <span class="sidebar-category-name" data-categories="algorithm-and-data-struct"><span class="iconfont-archer">&#xe60a;</span>algorithm-and-data-struct</span>
    
        <span class="sidebar-category-name" data-categories="caffe"><span class="iconfont-archer">&#xe60a;</span>caffe</span>
    
        <span class="sidebar-category-name" data-categories="common-misc"><span class="iconfont-archer">&#xe60a;</span>common-misc</span>
    
        <span class="sidebar-category-name" data-categories="cpp"><span class="iconfont-archer">&#xe60a;</span>cpp</span>
    
        <span class="sidebar-category-name" data-categories="linux-daily"><span class="iconfont-archer">&#xe60a;</span>linux-daily</span>
    
        <span class="sidebar-category-name" data-categories="ffmpeg"><span class="iconfont-archer">&#xe60a;</span>ffmpeg</span>
    
    </div>
    <div class="iconfont-archer sidebar-categories-empty">&#xe678;</div>
    <div class="sidebar-categories-list"></div>
</div>
    </div>
</div> 
    <script>
    var siteMeta = {
        root: "/",
        author: "ddddfang"
    }
</script>
    <!-- CDN failover -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script type="text/javascript">
        if (typeof window.$ === 'undefined')
        {
            console.warn('jquery load from jsdelivr failed, will load local script')
            document.write('<script src="/lib/jquery.min.js">\x3C/script>')
        }
    </script>
    <script src="/scripts/main.js"></script>
    <!-- algolia -->
    
    <!-- busuanzi  -->
    
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    
    <!-- CNZZ  -->
    
    </div>
    <!-- async load share.js -->
    
        <script src="/scripts/share.js" async></script>    
     
    </body>
</html>


